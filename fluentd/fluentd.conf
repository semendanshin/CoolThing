<source>
  @type forward
  port 24224
</source>

<filter tg-**>
  @type concat
  key log
  separator "\n"
  # Настройка условий завершения объединения
  multiline_start_regexp /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3} - /
  flush_interval 5s
  timeout_label @END
</filter>

<filter tg-**>
  @type parser
  key_name log
  reserve_data yes
  <parse>
    @type regexp
    expression /^(?<logtime>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (?<logger>.*?) - (?<level>\w+) - (?<message>.*)$/
    time_format %Y-%m-%d %H:%M:%S,%L
  </parse>
</filter>

<match tg-**>
  @type copy

  <store>
	@type file
	path /var/log/fluentd/${tag}/%Y-%m-%d.log
	append true
	<buffer tag, time>
		@type file
		path /var/log/fluentd/${tag}/buffer
		flush_mode interval
		flush_interval 5s
		flush_at_shutdown true
	</buffer>
	<format>
		@type json
	</format>
  </store>

  <store>
  	@type stdout
  	<format>
  		@type single_value
  		message_key log
  	</format>
  </store>
</match>

<label @END>
  <match **>
	@type null
  </match>
</label>