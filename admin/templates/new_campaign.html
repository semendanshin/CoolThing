{% extends 'base.html' %}

{% block title %}
    Campaign
{% endblock %}

{% block head %}
    <link href="/static/form.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/campaign.css">
    <link rel="stylesheet" href="/static/filters.css">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="form-header-container">
            <div class="form-header">
                <h1>Campaign</h1>
                <p>Here you can create a new campaign.</p>
            </div>
        </div>
        <form action="/campaigns" method="post">
            <div class="row">
                <label for="name" class="field-label required">Name</label>
                <input class="input-field" id="name" name="name" placeholder="Skillbox1" required>
            </div>
            <div class="row">
                <label for="scope" class="field-label required">Scope</label>
                <input class="input-field" id="scope" name="scope" placeholder="Real Estate" required>
            </div>
            <div class="row">
                <input type="hidden" id="selected-campaign-type" name="type" value="Native integration">
                <label for="campaign_type" class="field-label required">Type</label>
                <div class="custom-select-wrapper">
                    <div class="custom-select" tabindex="0" id="custom-select-type">
                        <span id="type-selected-option" class="selected-option">No type selected</span>
                        <span>&#9660;</span>
                    </div>
                    <div class="custom-select-options" id="custom-select-options-type">
                        <div class="custom-select-option type" data-value="native integration">Native integration</div>
                        <div class="custom-select-option type" data-value="monitoring">Monitoring</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <label class="field-label">In-chat answer delay interval (seconds)</label>
                <div class="splitted-row">
                    <div class="splitted-row-element">
                        <label for="campaign_chat_interval_start" class="field-label sub-field-label">from:</label>

                        <input type="number" class="input-field" id="campaign_chat_interval_start"
                               name="campaign_chat_interval_start" value="15">
                    </div>

                    <div class="splitted-row-element">
                        <label for="campaign_chat_interval_end" class="field-label sub-field-label">to:</label>

                        <input type="number" class="input-field" id="campaign_chat_interval_end"
                               name="campaign_chat_interval_end" value="30">
                    </div>
                </div>
            </div>
            <div class="monitoring-fields" data-type="Monitoring">
                <div class="row">
                    <label class="field-label">Welcome message delay interval (seconds)</label>
                    <div class="splitted-row">
                        <div class="splitted-row-element">
                            <label for="campaign_welcome_wait_start" class="field-label sub-field-label">from:</label>
                            <input type="number" class="input-field" id="campaign_welcome_wait_start"
                                   name="campaign_welcome_wait_start" value="150">
                        </div>
                        <div class="splitted-row-element">
                            <label for="campaign_welcome_wait_end" class="field-label sub-field-label">to:</label>
                            <input type="number" class="input-field" id="campaign_welcome_wait_end"
                                   name="campaign_welcome_wait_end" value="300">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <label for="campaign_welcome_message" class="field-label">Welcome Message</label>
                    <textarea class="input-field" id="campaign_welcome_message"
                              name="welcome_message"></textarea>
                </div>
                <div class="row">
                    <label for="campaign_chats" class="field-label">Chats</label>
                    <textarea class="input-field" id="campaign_chats"
                              name="chats"></textarea>
                </div>
                <div class="row">
                    <label for="campaign_plus_keywords" class="field-label">Plus Keywords</label>
                    <textarea class="input-field" id="campaign_plus_keywords"
                              name="plus_keywords"></textarea>
                </div>
                <div class="row">
                    <label for="campaign_minus_keywords" class="field-label">Minus Keywords</label>
                    <textarea class="input-field" id="campaign_minus_keywords"
                              name="minus_keywords"></textarea>
                </div>
                <div class="row">
                    <label for="campaign_gpt_settings_id" class="field-label">GPT Settings</label>
                    <select class="select-field" id="campaign_gpt_settings_id" name="campaign_gpt_settings_id">
                        {% for gpt_setting in gpt_settings %}
                            <option value="">{{ gpt_setting.id }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row">
                <input type="submit" value="Create" class="submit-button">
            </div>
        </form>
    </div>

    <script>
        function mapListenersToSelects() {
            const customSelects = document.querySelectorAll('.custom-select-wrapper');
            customSelects.forEach(selectWrapper => {
                const select = selectWrapper.querySelector('.custom-select');
                const options = selectWrapper.querySelector('.custom-select-options');

                select.addEventListener('click', function () {
                    console.log(select);
                    options.classList.toggle('active');
                });

                options.querySelectorAll('.custom-select-option').forEach(option => {
                    option.addEventListener('click', function () {
                        const selectedOption = select.querySelector('span');
                        selectedOption.textContent = this.textContent;
                        options.classList.remove('active');
                        let event = new Event("optionSelected");
                        event.optionType = 'type' ? 'type' in option.classList : 'bot'
                        document.dispatchEvent(event);
                    });
                });
            });

            document.addEventListener('click', function (e) {
                customSelects.forEach(selectWrapper => {
                    const select = selectWrapper.querySelector('.custom-select');
                    const options = selectWrapper.querySelector('.custom-select-options');
                    if (!select.contains(e.target)) {
                        options.classList.remove('active');
                    }
                });
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            mapListenersToSelects();
            const hiddenInput = document.getElementById("selected-campaign-type");

            document.addEventListener("optionSelected", function (e) {
                if (e.optionType === 'bot') {
                    return;
                }
                hiddenInput.value = document.getElementById("type-selected-option").textContent;
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            function toggleFields() {
                const selectedType = document.getElementById('type-selected-option').textContent.trim().toLowerCase();
                const monitoringFields = document.querySelectorAll('[data-type="Monitoring"]');
                const integrationFields = document.querySelectorAll('[data-type="Native integration"]');

                monitoringFields.forEach(field => {
                    field.style.display = selectedType === 'monitoring' ? 'block' : 'none';
                });

                integrationFields.forEach(field => {
                    field.style.display = selectedType === 'native integration' ? 'block' : 'none';
                });
            }

            // On page load, set the visibility based on the initial value
            toggleFields();

            // Add event listener to detect type change
            document.addEventListener('optionSelected', function (e) {
                if (e.optionType === 'bot') {
                    return;
                }
                toggleFields();
            });
        });
    </script>
{% endblock %}
